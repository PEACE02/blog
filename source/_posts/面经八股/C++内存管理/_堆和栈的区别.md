---
title: 堆和栈的区别
date: 2023-10-12 00:00:00
tags:
updated:
categories:
- 面经八股
- C++内存管理
keywords:
description: 管理方式、空间上限、内存碎片、生长方向、分配方式、分配效率
cover: 
---

堆、栈都是放在内存里的，就是 RAM，内存条。

# 管理方式

栈：编译器自动管理，无需手动控制；
堆：释放工作由程序员控股之，容易产生内存泄漏。


# 空间上限

在 32 位系统下，单进程最大可以达到 4G 内存（4字节指针可表示的范围），所以堆空间理论可以申请接近 4G，当然实际情况可能更复杂，要考虑具体使用的操作系统和系统进程的预留内存。在 64 位系统下，可支持的内存大小已经相当大了，可以认为是无限制的，此时进程的堆内存上限主要受制于物理内存。

而栈空间一般比堆空间小的多，根据操作系统或编译器不同，通常有一个默认的预留大小，比如 1MB，8MB...也有自定义的选项，但总的来说，栈空间上限要比堆小得多。


# 内存碎片

在堆上，频繁的 new/delete 会造成内存空间的不连续，造成大量内存碎片，降低空间利用率。而栈不会出现这个问题，栈是先进后出，动态「增长／回退」的方式进行空间管理。


# 生长方向

堆空间向内存地址增加的方向增长，栈空间向内存地址减小的方向增长。


# 分配方式

堆都是动态分配的，是运行时通过 new/malloc 申请分配，需要手动通过 delete/free 释放，否则会造成内存泄漏。

栈有静态分配和动态分配。静态分配是编译器完成的，比如局部变量的分配；动态分配由 alloca 函数进行分配，不需要手动释放。


# 分配效率

栈是机器系统提供的数据结构，计算机会在底层对栈提供支持，分配专门的寄存器存放栈地址，压栈出栈都有专门的指令执行；堆则是 C/C++ 函数库提供的，它的机制很复杂，例如为了分配一块内存，库函数会按照一定的算法，在堆内存中搜索可用的足够大小的空间，如果没有足够大小的空间，就可能调用系统功能去增加程序数据段的内存空间，这样就有机会分到足够大小的内存，然后进行返回。显然，堆的效率要比栈低得多。


# 参考

[堆和栈的区别](https://www.cnblogs.com/powersun/archive/2007/08/13/853555.html)

[为何微软不在新的操作系统中让 32 位支持大于 4GB 的内存？](https://www.zhihu.com/question/22594254/answer/42967413)

[为什么栈相对于堆很小？](https://www.zhihu.com/question/59238963)

[C语言内存碎片如何处理？](https://www.zhihu.com/question/51836333/answer/145693402)

[内存分配之malloc函数和alloca函数辨析](https://zhuanlan.zhihu.com/p/449165315)

[栈为什么效率比堆高](https://www.jianshu.com/p/27c0fc1aecab)